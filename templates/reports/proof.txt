<%
    import pandas as pd
    def replace_empties(value): 
        if value:
            return value 
        else: 
            return 0

    def recover_empty_values(value):
        if value == 0:
            return None
        else:
            return value

    def replace_and_show(data):
        plotter.fill(data, recover_empty_values)
        print(data)


    disease=plotter.hash_vars["disease"].replace("_profile", "").capitalize()
    plotter.hash_vars["candidates_sims"].sort(key=lambda row: float(row[1]), reverse=True) 
    plotter.hash_vars["candidates_sims"] = plotter.hash_vars["candidates_sims"][0:50]
    
    pubmed_ids_and_sims = pd.DataFrame(plotter.hash_vars["candidates_sims"], columns=["pubmed_id", "similarity"])
    pubmed_ids_and_titles = pd.DataFrame(plotter.hash_vars["pubmed_ids_and_titles"], columns=["pubmed_id", "title", "article-type", "article-category"])
    
    pubmed_ids_sims_and_titles = pd.merge(pubmed_ids_and_sims, pubmed_ids_and_titles, on="pubmed_id", how="inner")
    pubmed_ids_sims_and_titles.drop(columns=["article-type", "article-category"], inplace=True) #convert back to a list of lists and add the header back
    pubmed_ids_sims_and_titles["similarity"] = pubmed_ids_sims_and_titles["similarity"].astype(float).round(2)
    pubmed_ids_sims_and_titles["pubmed_id"] = pubmed_ids_sims_and_titles["pubmed_id"].apply(lambda pmid: f"<a href=https://pubmed.ncbi.nlm.nih.gov/{pmid}>{pmid}</a>")
    plotter.hash_vars[f"supp_info.txt"] = pubmed_ids_sims_and_titles.values.tolist()
    plotter.hash_vars[f"supp_info.txt"].insert(0, ["pubmed_id", "similarity", "title"])
%>

<%  disease_div = f"<h1> {disease} Syndrome</h1>"   %>
${plotter.prettify_div(disease_div)}

<div class="container-fluid row-offcanvas nopadding">
    <div class="col-sm-7 nopadding">
        <div style="width: 90%; background-color:#ecf0f1; margin: 0 auto;"> 
            <h1 style="text-align: center; background-color:#d6eaf8">Similarity matrix</h1>
            ${plotter.prettify_div(
                plotter.heatmap( id= "similarity_matrix", header= True, row_names= True, 
                                prefill = replace_empties, func = replace_and_show,
                                x_label="Ontological Similarity", title = f"Top 50 articles more related to {disease} phenotypic profile",
                                extra_data={'id': 'stEngine_sims_table', 'header': True, 'row_names':  True, 'prefill': replace_empties, 'func' : replace_and_show},
                                config = {'sizeLegendTitle': 'Textual Similarity',
                                          'setMaxX': 1,
                                          'sizes': [3,8,9,11,13,15,16]} )
            )}
        </div>

        <div style="width: 90%; background-color:#ecf0f1; margin: 0 auto;"> 
            <h1 style="text-align: center; background-color:#d6eaf8">Negative terms matrix</h1>
            ${plotter.prettify_div(
                plotter.heatmap( id= "negative_matrix", header= True, row_names= True,
                                 title= f"Most recurrent negative terms found in top 50 articles for {disease}",
                                 x_label= "Counts" )
            )}
        </div>
    </div>

    <div class="col-sm-5 nopadding">
        ${plotter.prettify_div(
            plotter.table(id="supp_info.txt", styled="dt", text=True, header=True, attrib = {'class' : 'table'}, 
                custom_buttons = ['copyHtml5', 'excelHtml5', 'csvHtml5', 'pdfHtml5'])
        )}
    </div>
</div>